# 后端工程师文档（BE）

## 1. 角色目标

- 负责运行时调度、配置模型、进程稳定性与错误处理。
- 保证多 Agent 并发执行和会话续聊可靠。

## 2. 负责范围

- 运行时管理：`src/codex_ai_teams/agent_runtime.py`
- 配置读写：`src/codex_ai_teams/config.py`
- 数据模型：`src/codex_ai_teams/models.py`
- 并发调度（历史模块）：`src/codex_ai_teams/orchestrator.py`

## 3. 当前实现要点

- 每个 Agent 使用独立会话 `session_id`。
- 调用外部 Codex CLI：
  - 首次：`codex exec --json`
  - 续聊：`codex exec resume --json <session_id>`
- 并发策略：`ThreadPoolExecutor` 并发 dispatch。
- 流式事件解析：
  - 读取 `thread.started` 回收 `thread_id`
  - 读取 `item.completed` 抽取消息/错误
- 超时与失败兜底：
  - 子进程超时 kill
  - 非 0 退出码返回 FAILED
  - 未取到回复返回 FAILED

## 4. 数据模型约定

- `AgentConfig`：agent_id/role/temperature/role_prompt/codex_params/session_id/extra_params
- `AgentResult`：agent_id/role/status/content
- `AgentLogEvent`：agent_id/role/status/message
- `AgentStatus`：`IDLE`/`RUNNING`/`DONE`/`FAILED`

## 5. BE 稳定性清单

- 启动前验证 `codex.js` 路径存在。
- 处理 stdout 非 JSON 行，避免解析崩溃。
- 保证单 Agent 失败不影响其他 Agent 返回。
- 会话写回后可在 UI 配置表中可见并持久化。
