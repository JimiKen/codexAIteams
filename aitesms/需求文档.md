# Codex AI Teams（PySide6 GUI）需求文档

## 1. 项目目标

构建一个桌面 GUI，用于组织多个 Agent 进行持续对话与执行。
用户主要通过 5 个页面完成操作：团队、配置、日志、文件、终端。

## 2. 核心页面需求

1. 团队页
- 顶部显示团队成员横向标识。
- 团队成员横向标识需包含中文角色名称（如：项目经理、前端工程师）。
- 无主任务入口，用户直接发送对话消息触发执行。
- 只保留一个 Agent 列表，列为：Agent、角色、状态、执行日志。
- 增加团队对话区：可对全部成员群发，也可单独对某个成员发送消息。
- 对话输入支持快捷键：Enter 发送，Shift+Enter 换行。
- 不需要独立执行日志大面板。
- 不需要汇总结果面板。

2. 配置页
- 可配置每个 Agent 的：
  - temperature
  - role prompt（表格列内编辑）
  - codex 参数
  - session id
  - 其他可扩展参数
- 可配置 Bridge 与 Telegram 参数：
  - bridge_url
  - timeout
  - retry
  - telegram token
  - telegram chat id
- 支持保存配置到 `config/teams.yaml`。

3. 日志页
- 日志以列表形式展示，字段：时间、agent、状态、级别、消息。
- 支持按日志级别筛选：error / normal。
- 支持导出 CSV 文件（持久化存档）。

4. 文件页
- 支持选择工作路径。
- 页面以资源管理器方式展示该路径下文件与目录树。

5. 终端页
- 支持输入命令并运行。
- 将终端输出消息接入页面显示。

## 3. 架构要求

### 3.1 GUI 层（PySide6）

- 左侧导航：团队 / 配置 / 日志 / 文件 / 终端。
- 右侧为对应页面内容。
- 统一深色主题与状态色（normal 绿色，error 红色）。

### 3.2 对话执行层

- 对话消息可单发或群发给 Agent。
- 群发时支持并发执行。
- 每个 Agent 必须运行在独立外部 Codex CLI 子进程中（独立 PID）。
- 每个 Agent 使用独立 session_id 与独立上下文持久化文件。
- 回调每个 Agent 的执行状态与行内执行日志。
- Agent 回复内容需可读，不可仅返回“已处理任务”占位语句。
- 单 Agent 失败不阻断其他 Agent。
- 调用方式：优先 `codex exec resume <session_id>`，首次会话使用 `codex exec` 并回收 thread_id。
- 执行输出需要支持流式回显（CLI 事件逐条进入 UI），体验接近终端持续输出。
- 对外部 CLI 超时需要有容错机制（至少一次自动重试 + 延长超时）。

### 3.3 配置层

- 从 `config/teams.yaml` 读取配置。
- 配置页修改后可回写 `config/teams.yaml`。

### 3.4 日志与文件层

- 运行日志存储在内存列表并可导出 CSV。
- 文件页绑定工作路径并展示目录树。

## 4. 交付要求

1. 可运行 GUI 的 5 页面结构。
2. 团队页满足“对话区 + Agent 列表 + 行内执行日志 + 团队对话（群发/单发）”。
3. 配置页可编辑并保存 Agent（含 role prompt）与 Telegram 参数。
4. 日志页支持筛选与 CSV 导出。
5. 文件页支持路径选择与目录浏览。
6. 终端页支持命令执行与消息输出。

## 5. 本轮变更（v1.15）

新增：

1. 配置页新增 Agent 温度、role prompt（表格列编辑）、Codex 参数、session id、扩展参数编辑能力。
2. 配置页新增 Telegram token/chat id 编辑能力。
3. 日志页新增 CSV 导出。
4. 文件页新增路径选择与资源管理器视图。
5. 终端页新增命令执行与输出接入。
6. 团队页新增对话区，支持群发与单发。
7. 团队成员标识新增中文角色展示。
8. 团队对话新增快捷发送：Enter 发送、Shift+Enter 换行。
9. Agent 回复改造为可读回答（含中文角色标识）。
10. 新增独立运行模型：4 个 Agent 使用 4 个独立进程运行。
11. 新增独立会话上下文持久化机制（按 agent_id + session_id）。
12. 调度器接入真实外部 Codex CLI（exec/exec resume）并解析 JSON 事件回复。
13. 修复 `exec resume` 参数兼容问题，恢复稳定续聊。
14. 新增流式输出能力：外部 CLI 输出事件实时进入 Agent 日志列。
15. 新增超时容错：外部 CLI 超时后自动重试一次并提高超时阈值。

修改：

1. 团队页改为“纯对话驱动”（移除主任务入口）。
2. 团队成员展示改为横向标识。
3. 团队对话输入框改为多行输入并提升显示高度，确保可输入。
4. Agent 列角色显示调整为“英文角色 / 中文角色”。
5. 对话执行链改为 GUI 并发调度独立进程并回传结果。
6. Agent 回复文本风格调整为直接回答（去掉“我是...”模板前缀）。
7. 独立进程执行主体由本地模板 Worker 升级为外部 Codex CLI。
8. 续聊路径切换为使用子进程 `cwd`，不再传 `-C` 参数。
9. 提示词规则增强：涉及工作路径问题必须回传完整路径文本。
10. 超时处理策略从“直接失败”升级为“自动重试一次”。

删除：

1. 删除汇总结果需求。
2. 删除独立执行日志大面板需求。

## 6. 本轮变更（v1.15）

新增：

1. 新增角色文档目录 `docs/roles`。
2. 新增项目经理角色文档 `docs/roles/项目经理文档.md`。
3. 新增前端工程师角色文档 `docs/roles/前端工程师文档.md`。
4. 新增后端工程师角色文档 `docs/roles/后端工程师文档.md`。
5. 新增测试工程师角色文档 `docs/roles/测试工程师文档.md`。
6. 新增角色文档索引 `docs/roles/README.md`。
